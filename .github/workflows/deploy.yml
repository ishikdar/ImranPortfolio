name: Deploy Portfolio to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Verify source files exist
        run: |
          echo "Checking source files..."
          ls -la site/public/pages/
          ls -la site/public/css/
          ls -la site/public/assets/ || echo "Assets directory not found"
          ls -la site/public/js/
          ls -la site/public/data/
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Copy files to build directory
        run: |
          mkdir -p _site
          echo "Copying HTML pages..."
          cp -r site/public/pages/* _site/
          echo "Copying CSS..."
          cp -r site/public/css _site/
          echo "Copying JS..."
          cp -r site/public/js _site/
          echo "Copying data..."
          cp -r site/public/data _site/
          echo "Copying assets..."
          if [ -d "site/public/assets" ]; then
            cp -r site/public/assets _site/
          else
            mkdir -p _site/assets
            echo "Assets directory created"
          fi
          
      - name: Create static build with API fallback
        run: |
          echo "Creating static build with API fallback for GitHub Pages..."
          node -e "
          const fs = require('fs');
          const path = require('path');
          const data = JSON.parse(fs.readFileSync('site/public/data/personalData.json', 'utf8'));
          
          // Create a static data script that mimics the API
          const staticDataScript = \`
          // Static data for GitHub Pages (fallback when backend is not available)
          window.STATIC_DATA = \${JSON.stringify(data, null, 2)};
          
          // Override fetch for API calls to use static data
          const originalFetch = window.fetch;
          window.fetch = function(url, options) {
            if (url.includes('/api/home') || url.includes('/api/index')) {
              return Promise.resolve({
                ok: true,
                json: () => Promise.resolve(window.STATIC_DATA)
              });
            }
            if (url.includes('/api/about')) {
              return Promise.resolve({
                ok: true,
                json: () => Promise.resolve(window.STATIC_DATA)
              });
            }
            if (url.includes('/api/contact')) {
              return Promise.resolve({
                ok: true,
                json: () => Promise.resolve(window.STATIC_DATA)
              });
            }
            // For other URLs, use original fetch (will fail gracefully on GitHub Pages)
            return originalFetch.apply(this, arguments).catch(() => ({
              ok: false,
              json: () => Promise.resolve({})
            }));
          };
          
          console.log('Static data loaded for GitHub Pages');
          \`;
          
          // Write the static data script
          fs.writeFileSync('_site/static-data.js', staticDataScript);
          
          // Update HTML files to include the static data script
          const htmlFiles = ['index.html', 'home.html', 'about.html', 'contact.html'];
          
          htmlFiles.forEach(filename => {
            if (fs.existsSync('_site/' + filename)) {
              let html = fs.readFileSync('_site/' + filename, 'utf8');
              
              // Add static data script before other scripts
              html = html.replace('<script', '<script src=\"static-data.js\"></script>\\n    <script');
              
              // If no scripts found, add before closing body tag
              if (!html.includes('<script')) {
                html = html.replace('</body>', '    <script src=\"static-data.js\"></script>\\n</body>');
              }
              
              fs.writeFileSync('_site/' + filename, html);
            }
          });
          
          console.log('Successfully created static build with API fallback!');
          "
          
          
      - name: Fix asset paths in HTML files
        run: |
          echo "Fixing paths in HTML files..."
          # Update CSS paths from ../css/ to css/
          sed -i 's|../css/|css/|g' _site/*.html
          # Update asset paths from ../assets/ to assets/
          sed -i 's|../assets/|assets/|g' _site/*.html
          # Update JS paths from ../js/ to js/
          sed -i 's|../js/|js/|g' _site/*.html
          # Update TypeScript server paths (remove backend references)
          sed -i 's|<script type="module" src="../../distribution/main.js"></script>||g' _site/*.html
          
      - name: List final build directory
        run: |
          echo "Final build directory contents:"
          ls -la _site/
          echo "HTML files:"
          ls -la _site/*.html
          
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4